<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="style.css">
    <meta charset="UTF-8" />
    <title>Processing Results</title>
</head>
<body onload="loadResults()" style="margin:0;">
    <div class="headerALL" >
        <h1>SSG: My Life's a Song</h1>
        <ul>
            <li onclick="window.location.href='upload.html'">Home</li>
            <li onclick="window.location.href='about.html'">About</li>
        </ul>
    </div>
    <p class="catchphrase">Create a soundtrack of my life!</p>
    <hr>
    
    <!-- Loading screen -->
    <div id="loadingScreen" class="loading-screen">
        <div>
            <h2>Processing Your File...</h2>
            <div class="Loader"></div>
        </div>
        <p class="loading-text">Please wait while we analyze your audio/video content.</p>
        <p id="progressText" style="color: #666; font-size: 14px; margin-top: 10px;">Starting analysis...</p>
    </div>
    <!--here I am including the random quote fact-->
    <script>
        const quotes = [
            "The first clip ever aired on MTV is the Buggles Video Killed the Radio Star. The first clip ever aired on MTV Europe is Dire Straits‚Äô Money For Nothing. (Mishal, Or. ‚Äú40 Amazing Music Facts That Will Shake Your Ears.‚Äù)",
            "Only three music companies are responsible for over 80% of the music you listen to Sony BMG, Warner Music Group, and Universal Music Group. (Mishal, Or. ‚Äú40 Amazing Music Facts That Will Shake Your Ears.‚Äù)",
            "Tame Impala is just one guy"
        ];
        const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
        document.write(`<p class="quote">${randomQuote}</p>`);
        </script>
    <!--end of the random quote fact-->
    
    <!-- Results display -->
    <div id="resultsContainer" style="display:none;" class="animate-bottom">
        <h2>Processing Results</h2>
        <div id="resultsContent"></div>
        <div style="margin-top: 20px;">
            <button onclick="window.location.href='/'" class="button button2">Process Another File</button>
        </div>
    </div>

    <script>
        async function loadResults() {
            const urlParams = new URLSearchParams(window.location.search);
            const filename = urlParams.get('filename');
            const isError = urlParams.get('error') === 'true';
            
            if (!filename) {
                showError('No filename provided');
                return;
            }
            
            // Start polling for status updates
            pollForResults(filename);
        }
        
        async function pollForResults(filename) {
            let attempts = 0;
            const maxAttempts = 300; // 10 minutes max (300 * 2 seconds)
            
            const pollInterval = setInterval(async () => {
                attempts++;
                
                try {
                    // First check processing status for progress updates
                    const statusResponse = await fetch(`/api/processing-status/${filename}`);
                    if (statusResponse.ok) {
                        const statusData = await statusResponse.json();
                        
                        if (statusData.success && statusData.status) {
                            // Update progress text
                            const progressText = document.getElementById('progressText');
                            if (progressText && statusData.status.progress) {
                                progressText.textContent = statusData.status.progress;
                            }
                            
                            if (statusData.status.status === 'completed') {
                                clearInterval(pollInterval);
                                // Get the final results
                                const resultsResponse = await fetch(`/api/processing-results/${filename}`);
                                const resultsData = await resultsResponse.json();
                                
                                if (resultsData.success && resultsData.result) {
                                    displayResults(resultsData.result, filename);
                                } else {
                                    showError('Processing completed but no results available');
                                }
                            } else if (statusData.status.status === 'error') {
                                clearInterval(pollInterval);
                                showError(statusData.status.error || 'Processing failed');
                            }
                        }
                    }
                    
                    // Check if we've exceeded max attempts
                    if (attempts >= maxAttempts) {
                        clearInterval(pollInterval);
                        showError('Processing is taking longer than expected. Please try again.');
                    }
                    
                } catch (error) {
                    console.error('Error polling for results:', error);
                    if (attempts >= maxAttempts) {
                        clearInterval(pollInterval);
                        showError('Failed to check processing status');
                    }
                }
            }, 2000); // Check every 2 seconds
        }
        
        function displayResults(result, filename) {
            const container = document.getElementById('resultsContainer');
            const content = document.getElementById('resultsContent');
            
            let html = `<h3>File: ${filename}</h3>`;
            html += `<p><strong>Type:</strong> ${result.type}</p>`;
            
            if (result.type === 'video') {
                html += `
                    <div style="margin: 20px 0;">
                        <h4>üéº Song Description</h4>
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #4caf50;">
                            ${result.songDescription ? result.songDescription.replace(/\n/g, '<br>') : 'Song description not available'}
                        </div>
                    </div>
                `;
                
                // Add song download section if song was generated
                if (result.songFile && result.songFile.success) {
                    html += `
                        <div style="margin: 20px 0;">
                            <h4>üéµ Generated Song</h4>
                            <div style="background: #f0f8ff; padding: 15px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #2196f3;">
                                <p><strong>Song generated successfully!</strong></p>
                                <p>Filename: ${result.songFile.filename}</p>
                                <a href="/api/songs/${result.songFile.filename}" download class="button button2" style="display: inline-block; margin-top: 10px;">
                                    üì• Download Song
                                </a>
                            </div>
                        </div>
                    `;
                }
            } else if (result.type === 'audio') {
                html += `
                    <div style="margin: 20px 0;">
                        <h4>üéµ Audio Analysis</h4>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 10px 0;">
                            ${result.description.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div style="margin: 20px 0;">
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 10px 0;">
                            ${result.description}
                        </div>
                    </div>
                `;
            }
            
            html += `<p style="color: #666; font-style: italic;">üóëÔ∏è File has been automatically deleted to save storage space.</p>`;
            
            content.innerHTML = html;
            
            // Hide loading, show results
            document.getElementById('loadingScreen').style.display = 'none';
            container.style.display = 'block';
        }
        
        function showError(message) {
            const container = document.getElementById('resultsContainer');
            const content = document.getElementById('resultsContent');
            
            content.innerHTML = `
                <div style="color: #d32f2f; background: #ffebee; padding: 15px; border-radius: 5px; margin: 10px 0;">
                    <h4>‚ùå Error</h4>
                    <p>${message}</p>
                </div>
            `;
            
            // Hide loading, show error
            document.getElementById('loadingScreen').style.display = 'none';
            container.style.display = 'block';
        }
    </script>
</body>
</html>