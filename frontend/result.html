<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="style.css">
    <meta charset="UTF-8" />
    <title>Processing Results</title>
</head>
<body onload="loadResults()" style="margin:0;">
    <div class="headerALL" >
        <h1>SSG: My Life's a Song</h1>
        <ul>
            <li><a href="/">Home</a></li>
            <li>About</li>
        </ul>
    </div>
    <hr>
    
    <!-- Loading screen -->
    <div id="loadingScreen" class="loading-screen">
        <div>
            <h2>Processing Your File...</h2>
            <div class="Loader"></div>
        </div>
        <p class="loading-text">Please wait while we analyze your audio/video content.</p>
        <p id="progressText" style="color: #666; font-size: 14px; margin-top: 10px;">Starting analysis...</p>
    </div>
    
    <!-- Results display -->
    <div id="resultsContainer" style="display:none;" class="animate-bottom">
        <h2>Processing Results</h2>
        <div id="resultsContent"></div>
        <div style="margin-top: 20px;">
            <button onclick="window.location.href='/'" class="button button2">Process Another File</button>
        </div>
    </div>

    <script>
        async function loadResults() {
            const urlParams = new URLSearchParams(window.location.search);
            const filename = urlParams.get('filename');
            const isError = urlParams.get('error') === 'true';
            
            if (!filename) {
                showError('No filename provided');
                return;
            }
            
            // Start polling for status updates
            pollForResults(filename);
        }
        
        async function pollForResults(filename) {
            let attempts = 0;
            const maxAttempts = 300; // 10 minutes max (300 * 2 seconds)
            
            const pollInterval = setInterval(async () => {
                attempts++;
                
                try {
                    // First check processing status for progress updates
                    const statusResponse = await fetch(`/api/processing-status/${filename}`);
                    if (statusResponse.ok) {
                        const statusData = await statusResponse.json();
                        
                        if (statusData.success && statusData.status) {
                            // Update progress text
                            const progressText = document.getElementById('progressText');
                            if (progressText && statusData.status.progress) {
                                progressText.textContent = statusData.status.progress;
                            }
                            
                            if (statusData.status.status === 'completed') {
                                clearInterval(pollInterval);
                                // Get the final results
                                const resultsResponse = await fetch(`/api/processing-results/${filename}`);
                                const resultsData = await resultsResponse.json();
                                
                                if (resultsData.success && resultsData.result) {
                                    displayResults(resultsData.result, filename);
                                } else {
                                    showError('Processing completed but no results available');
                                }
                            } else if (statusData.status.status === 'error') {
                                clearInterval(pollInterval);
                                showError(statusData.status.error || 'Processing failed');
                            }
                        }
                    }
                    
                    // Check if we've exceeded max attempts
                    if (attempts >= maxAttempts) {
                        clearInterval(pollInterval);
                        showError('Processing is taking longer than expected. Please try again.');
                    }
                    
                } catch (error) {
                    console.error('Error polling for results:', error);
                    if (attempts >= maxAttempts) {
                        clearInterval(pollInterval);
                        showError('Failed to check processing status');
                    }
                }
            }, 2000); // Check every 2 seconds
        }
        
        function displayResults(result, filename) {
            const container = document.getElementById('resultsContainer');
            const content = document.getElementById('resultsContent');
            
            let html = `<h3>File: ${filename}</h3>`;
            html += `<p><strong>Type:</strong> ${result.type}</p>`;
            
            if (result.type === 'video') {
                html += `
                    <div style="margin: 20px 0;">
                        <h4>üéµ Audio Analysis</h4>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 10px 0;">
                            ${result.audioDescription.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                    <div style="margin: 20px 0;">
                        <h4>üé¨ Video Analysis</h4>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 10px 0;">
                            ${result.videoDescription.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                `;
                
                // Add generated song section if available
                if (result.songFile) {
                    html += `
                        <div style="margin: 20px 0;">
                            <h4>üéµ Generated Song</h4>
                            <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 10px 0;">
                                <p><strong>Song File:</strong> ${result.songFile}</p>
                                <audio controls style="width: 100%; margin-top: 10px;">
                                    <source src="/generated-songs/${result.songFile}" type="audio/mpeg">
                                    Your browser does not support the audio element.
                                </audio>
                                <p style="margin-top: 10px; font-size: 14px; color: #666;">
                                    <a href="/generated-songs/${result.songFile}" download="${result.songFile}" 
                                       style="color: #bc74f4; text-decoration: none;">
                                        üì• Download Song
                                    </a>
                                </p>
                            </div>
                        </div>
                    `;
                }
            } else if (result.type === 'audio') {
                html += `
                    <div style="margin: 20px 0;">
                        <h4>üéµ Audio Analysis</h4>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 10px 0;">
                            ${result.description.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div style="margin: 20px 0;">
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 10px 0;">
                            ${result.description}
                        </div>
                    </div>
                `;
            }
            
            html += `<p style="color: #666; font-style: italic;">üóëÔ∏è Original file has been automatically deleted to save storage space.</p>`;
            
            content.innerHTML = html;
            
            // Hide loading, show results
            document.getElementById('loadingScreen').style.display = 'none';
            container.style.display = 'block';
        }
        
        function showError(message) {
            const container = document.getElementById('resultsContainer');
            const content = document.getElementById('resultsContent');
            
            content.innerHTML = `
                <div style="color: #d32f2f; background: #ffebee; padding: 15px; border-radius: 5px; margin: 10px 0;">
                    <h4>‚ùå Error</h4>
                    <p>${message}</p>
                </div>
            `;
            
            // Hide loading, show error
            document.getElementById('loadingScreen').style.display = 'none';
            container.style.display = 'block';
        }
    </script>
</body>
</html>